#!/bin/bash

# SketchyBar Pro Preset
# Full-featured status bar with system stats and media
# Colors are provided by Flowstate via environment variables

PLUGIN_DIR="$HOME/.config/sketchybar/plugins"
FONT="SF Pro"

# Detect available Nerd Font
NERD_FONTS=("Hack Nerd Font" "JetBrainsMono Nerd Font" "FiraCode Nerd Font" "MesloLGS Nerd Font")
ICON_FONT=""
for nf in "${NERD_FONTS[@]}"; do
  if fc-list : family 2>/dev/null | grep -qi "${nf%% *}"; then
    ICON_FONT="$nf"
    break
  fi
done

# Fallback to SF Pro if no Nerd Font found
if [ -z "$ICON_FONT" ]; then
  ICON_FONT="$FONT"
  USE_FALLBACK_ICONS=true
else
  USE_FALLBACK_ICONS=false
fi

# Icon definitions (Nerd Font vs Fallback)
if [ "$USE_FALLBACK_ICONS" = true ]; then
  ICON_APPLE="♦"
  ICON_MUSIC="♫"
  ICON_CLOCK="◷"
  ICON_CALENDAR="◫"
  ICON_BATTERY_FULL="█"
  ICON_BATTERY_75="▇"
  ICON_BATTERY_50="▅"
  ICON_BATTERY_25="▃"
  ICON_BATTERY_LOW="▁"
  ICON_BATTERY_CHARGING="⚡"
  ICON_VOLUME_HIGH="●●●"
  ICON_VOLUME_MED="●●○"
  ICON_VOLUME_LOW="●○○"
  ICON_VOLUME_MUTE="○"
  ICON_CPU="◈"
  ICON_MEMORY="▣"
  SPACE_ICONS=("1" "2" "3" "4" "5" "6" "7" "8" "9" "10")
else
  ICON_APPLE="󰀵"
  ICON_MUSIC="󰎆"
  ICON_CLOCK=""
  ICON_CALENDAR=""
  ICON_BATTERY_FULL=""
  ICON_BATTERY_75=""
  ICON_BATTERY_50=""
  ICON_BATTERY_25=""
  ICON_BATTERY_LOW=""
  ICON_BATTERY_CHARGING=""
  ICON_VOLUME_HIGH="󰕾"
  ICON_VOLUME_MED="󰖀"
  ICON_VOLUME_LOW="󰕿"
  ICON_VOLUME_MUTE="󰖁"
  ICON_CPU="󰻠"
  ICON_MEMORY="󰍛"
  SPACE_ICONS=("󰎤" "󰎧" "󰎪" "󰎭" "󰎱" "󰎳" "󰎶" "󰎹" "󰎼" "󰎿")
fi

# Ensure plugin directory exists
mkdir -p "$PLUGIN_DIR"

# ============== Bar Appearance ==============
sketchybar --bar \
  height=40 \
  blur_radius=30 \
  position=top \
  sticky=off \
  padding_left=16 \
  padding_right=16 \
  color="$BAR_COLOR" \
  border_color="$BAR_BORDER_COLOR" \
  border_width=0 \
  shadow=on \
  y_offset=0 \
  margin=0

# ============== Default Item Properties ==============
sketchybar --default \
  icon.font="$ICON_FONT:Regular:14.0" \
  icon.color="$ICON_COLOR" \
  label.font="$FONT:Semibold:13.0" \
  label.color="$LABEL_COLOR" \
  background.color="$ITEM_BG_COLOR" \
  background.corner_radius=6 \
  background.height=28 \
  background.padding_left=4 \
  background.padding_right=4 \
  padding_left=6 \
  padding_right=6 \
  icon.padding_left=6 \
  icon.padding_right=4 \
  label.padding_left=4 \
  label.padding_right=6

# ============== Left Items ==============

# Apple logo with menu
sketchybar --add item apple left \
  --set apple \
    icon="$ICON_APPLE" \
    icon.font="$ICON_FONT:Regular:20.0" \
    icon.color="$COLOR_ACCENT" \
    icon.padding_left=4 \
    icon.padding_right=10 \
    background.drawing=off \
    click_script="open -a 'System Preferences'"

# Space indicators with workspace icons
for i in "${!SPACE_ICONS[@]}"; do
  sid=$((i + 1))
  sketchybar --add space space.$sid left \
    --set space.$sid \
      space=$sid \
      icon="${SPACE_ICONS[i]}" \
      icon.padding_left=10 \
      icon.padding_right=10 \
      background.color="$ITEM_BG_COLOR" \
      background.corner_radius=6 \
      background.drawing=off \
      label.drawing=off \
      script='
        if [ "$SELECTED" = "true" ]; then
          sketchybar --set $NAME background.drawing=on icon.color="'"$COLOR_ACCENT"'" background.color="'"$COLOR_SELECTION"'"
        else
          sketchybar --set $NAME background.drawing=off icon.color="'"$ICON_COLOR"'"
        fi
      ' \
    --subscribe space.$sid space_change
done

# Separator
sketchybar --add item separator left \
  --set separator \
    icon="│" \
    icon.color="$COLOR_BORDER" \
    icon.font="$FONT:Regular:16.0" \
    background.drawing=off \
    padding_left=6 \
    padding_right=6

# Front app
sketchybar --add item front_app left \
  --set front_app \
    icon.drawing=off \
    label.font="$FONT:Bold:13.0" \
    label.color="$COLOR_ACCENT" \
    background.drawing=off \
    padding_left=4 \
    script='sketchybar --set $NAME label="$INFO"' \
  --subscribe front_app front_app_switched

# ============== Center Items ==============

# Media / Now Playing
sketchybar --add item media center \
  --set media \
    icon="$ICON_MUSIC" \
    icon.color="$COLOR_ACCENT" \
    label.max_chars=40 \
    scroll_texts=on \
    background.drawing=on \
    background.color="$ITEM_BG_COLOR" \
    script='
      STATE="$(echo "$INFO" | jq -r ".state")"
      if [ "$STATE" = "playing" ]; then
        MEDIA="$(echo "$INFO" | jq -r ".title + \" - \" + .artist")"
        sketchybar --set $NAME label="$MEDIA" drawing=on
      else
        sketchybar --set $NAME drawing=off
      fi
    ' \
  --subscribe media media_change

# ============== Right Items ==============

# Clock
sketchybar --add item clock right \
  --set clock \
    icon="$ICON_CLOCK" \
    icon.color="$COLOR_ACCENT" \
    background.drawing=on \
    update_freq=10 \
    script='sketchybar --set $NAME label="$(date "+%H:%M:%S")"'

# Date
sketchybar --add item date right \
  --set date \
    icon="$ICON_CALENDAR" \
    icon.color="$COLOR_ACCENT" \
    background.drawing=on \
    update_freq=60 \
    script='sketchybar --set $NAME label="$(date "+%a %d %b")"'

# Separator
sketchybar --add item sep2 right \
  --set sep2 \
    icon="│" \
    icon.color="$COLOR_BORDER" \
    background.drawing=off \
    padding_left=4 \
    padding_right=4

# Battery with time remaining
sketchybar --add item battery right \
  --set battery \
    icon.color="$COLOR_ACCENT" \
    background.drawing=on \
    update_freq=120 \
    script='
      PERCENTAGE=$(pmset -g batt | grep -Eo "\d+%" | head -1 | cut -d% -f1)
      CHARGING=$(pmset -g batt | grep -c "AC Power")
      TIME_LEFT=$(pmset -g batt | grep -Eo "\d+:\d+" | head -1)

      if [ "$CHARGING" -eq 1 ]; then
        ICON="'"$ICON_BATTERY_CHARGING"'"
        LABEL="${PERCENTAGE}%"
      elif [ "$PERCENTAGE" -gt 80 ]; then
        ICON="'"$ICON_BATTERY_FULL"'"
        LABEL="${PERCENTAGE}%"
      elif [ "$PERCENTAGE" -gt 60 ]; then
        ICON="'"$ICON_BATTERY_75"'"
        LABEL="${PERCENTAGE}%"
      elif [ "$PERCENTAGE" -gt 40 ]; then
        ICON="'"$ICON_BATTERY_50"'"
        LABEL="${PERCENTAGE}%"
      elif [ "$PERCENTAGE" -gt 20 ]; then
        ICON="'"$ICON_BATTERY_25"'"
        LABEL="${PERCENTAGE}%"
      else
        ICON="'"$ICON_BATTERY_LOW"'"
        LABEL="${PERCENTAGE}%"
      fi

      if [ -n "$TIME_LEFT" ] && [ "$CHARGING" -eq 0 ]; then
        LABEL="$LABEL ($TIME_LEFT)"
      fi

      sketchybar --set $NAME icon="$ICON" label="$LABEL"
    '

# Volume with slider
sketchybar --add item volume right \
  --set volume \
    icon.color="$COLOR_ACCENT" \
    background.drawing=on \
    script='
      VOLUME=$(osascript -e "output volume of (get volume settings)")
      MUTED=$(osascript -e "output muted of (get volume settings)")

      if [ "$MUTED" = "true" ]; then
        ICON="'"$ICON_VOLUME_MUTE"'"
      elif [ "$VOLUME" -gt 60 ]; then
        ICON="'"$ICON_VOLUME_HIGH"'"
      elif [ "$VOLUME" -gt 30 ]; then
        ICON="'"$ICON_VOLUME_MED"'"
      elif [ "$VOLUME" -gt 0 ]; then
        ICON="'"$ICON_VOLUME_LOW"'"
      else
        ICON="'"$ICON_VOLUME_MUTE"'"
      fi

      sketchybar --set $NAME icon="$ICON" label="${VOLUME}%"
    ' \
  --subscribe volume volume_change

# Separator
sketchybar --add item sep3 right \
  --set sep3 \
    icon="│" \
    icon.color="$COLOR_BORDER" \
    background.drawing=off \
    padding_left=4 \
    padding_right=4

# CPU usage
sketchybar --add item cpu right \
  --set cpu \
    icon="$ICON_CPU" \
    icon.color="$COLOR_ACCENT" \
    background.drawing=on \
    update_freq=5 \
    script='
      CPU=$(top -l 1 | grep -E "^CPU" | awk "{print \$3}" | cut -d% -f1)
      sketchybar --set $NAME label="${CPU}%"
    '

# Memory usage
sketchybar --add item memory right \
  --set memory \
    icon="$ICON_MEMORY" \
    icon.color="$COLOR_ACCENT" \
    background.drawing=on \
    update_freq=10 \
    script='
      MEMORY=$(memory_pressure | grep "System-wide memory free percentage:" | awk "{print 100-\$5}" | cut -d% -f1)
      sketchybar --set $NAME label="${MEMORY}%"
    '

# ============== Finalizing ==============

# Force all scripts to run once
sketchybar --update
sketchybar --trigger space_change
sketchybar --trigger front_app_switched
